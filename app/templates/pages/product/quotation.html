
{% extends 'base/container.html' %}
{% load static %}
{% block title %}Product {% endblock %}

{% block style %}

<style>
 .card-custom-header {
    display: flex;
    align-content: center;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 800;
}
.custom-row-data {
    display: flex;
    flex-wrap: nowrap;
    gap: 12px;
    padding: 0px 10px 0px 12px;
}
.form-body {
    padding: 12px;
    background-color: #f4f4f4;
    border-radius: 5px;
}
.group-icon-f{
    display: flex;
    align-items: center;
    gap: 5px;
}
.group-icon-f i {
    background-color: #94939300;
    font-size: 25px;
}
.har-row{
 
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    flex-direction: row;
    justify-content: space-between;
 
}
.action-btn {
    margin-top: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
    background-color: white;
    padding: 10px;
    border-radius: 5px;
}
</style>
    <link href="{% static 'assets/advanced-datatable/media/css/demo_page.css'%}" rel="stylesheet" />
    <link href="{% static 'assets/advanced-datatable/media/css/demo_table.css'%}" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'assets/data-tables/DT_bootstrap.css'%}" />
    <!-- Bootstrap JS (v5.x) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
{% block body_content %} 

 <div class="wrapper">
 

    <div class="card ">
        <ul class="nav nav-tabs mb-2" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true"> <i class="fa fa-home pr-2"></i>Quotation List</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Quotation Form</a>
            </li>
        </ul>
        <div class="tab-content card-body" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <!--Qoutaion List Table Start-->
                 <div class="adv-table">
                       <table class="display table table-bordered" id="hidden-table-info">
                            <thead>
                               <tr>  
                                    <th style="display:none">Id</th>
                                    <th>Invoice Number</th>
                                    <th>Request User</th>
                                    <th>Request Date</th>
                                    <th style="display:none">Item-json</th>    
                                </tr>
                            </thead>
                            <tbody>
                               
                                {% for quotation in quotations%}
                                <tr class="gradeX">
                                    <th style="display:none" data-id="{{quotation.id}}" data-user="{{quotation.approver.id}}" data-status="{{quotation.approver_status}}" >{{quotation.id}}</th>
                                    <td>{{quotation.invoice_number}}</td>
                                    <td>{{quotation.customer.last.name}}</td>
                                    <td>{{ quotation.request_date|date:"d M Y" }}</td>
                                    <td style="display:none">{{ quotation.items_to_json|safe }}</td>
                                </tr>   
                                {% endfor%}
                           </tbody>
                       </table>
                    </div>

                <!--Qoutaion List Table End-->  
            </div>
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                  <div class="card">
                    <form  class="cmxform form-horizontal tasi-form" id="project-add-form" method="post" action="#">
                        {% csrf_token %}
                        <div class="har-row">
                            <div class="col-5">
                                <label class="" for="inlineFormInput">Customer</label>
                                 <div class="group-icon-f">
                                 <select class="form-control select2" id="category" name="user">
                                        {% for user in users %}
                                            <option value="{{ user.id }}">{{ user }}</option>
                                        {% empty %}
                                            <option disabled>No user available</option>
                                        {% endfor %}
                                 </select>
                                 <a href=""  href="#" data-toggle="modal" data-target="#add-customer">
                                    <i class="fa fa-user"></i></a>
                                 </div>
                            </div>
                            <div class="col-5">
                                <label for="requite_date" class="control-label ">Request Date</label>
                                <input type="date" class="form-control" name="requite_date" required/>
                            </div>
                             <div class="col-2"> 
                                <label for=" " class="control-label "></label>
                                 <a href="#" id="add-request-btn" class="add-request-btn">
                                <i class="fa fa-plus text-success" style="font-size: 20px;"></i></a>
                            </div>          
                        </div>
                         <div id="add-requests" class="form-body"></div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="submit" id="category-submit" class="btn btn-primary">Save</button>
                            </div>
                    </form>
 
                 </div> 
            </div>
         </div>
    </div>



    <!--Add user Model Start-->
    <div class="modal fade" id="add-customer" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add Customer</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                     <form class="" id="customer-form">
                       {% csrf_token %}
                        <div class="form-group row">
                            <label for="inputEmail3" class="col-sm-2 col-form-label">Name</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="name" name="name" placeholder="Name" required>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="inputEmail3" class="col-sm-2 col-form-label">Email</label>
                            <div class="col-sm-10">
                                <input type="email" class="form-control" name="email" id="inputEmail3" placeholder="Email" required>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="phonenumber" class="col-sm-2 col-form-label">Phone Number</label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control"name="phone_number" id="phone_number" placeholder="1233" required>
                            </div>
                        </div>
                         <div class="form-group row">
                            <label for="gstnumber" class="col-sm-2 col-form-label">GST Number</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control"name="gst_number" id="gstnumber" placeholder="GST Number" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id ="submit-customer">Add</button>
                        </div>
                    </form>
                </div>
 
            </div>
        </div>
    </div>
    <!--Add User model End-->

</div>

{% endblock %}
{% block js %}
       <script>
              function fnFormatDetails(oTable, nTr) {
                const data = oTable.fnGetData(nTr);
                let itemData = [];
                const dataitems = data;
                const quotationId = $(nTr).find("th[data-id]").data("id");
                const approver = $(nTr).find("th[data-user]").data("user");
                const approvestatus = $(nTr).find("th[data-status]").data("status");

                console.log(dataitems)
                try {
                    const htmlContent = $('<div>').html(data[5]).text();

                    const fixedContent = htmlContent
                        .replace(/'/g, '"')
                        .replace(/None/g, 'null')
                        .replace(/True/g, 'true')
                        .replace(/False/g, 'false');

                    itemData = JSON.parse(fixedContent);

                } catch (e) {
                    console.error("Error parsing JSON:", e);
                    return '<div style="color:red;">Failed to load item data</div>';
                }

                if (!itemData.items || itemData.items.length === 0) {
                    return '<div>No items available</div>';
                }
                let sOut =``
                if (approvestatus === 'approved') {
                        sOut += `<div style="margin-bottom: 10px;display: flex;justify-content: flex-end;">
                                    <button onclick="Apitest(${quotationId})" class="btn btn-sm btn-outline-primary">
                                        <i class="fa fa-download"></i> Download
                                    </button>
                                </div>`;
                    }
                

                sOut += '<table cellpadding="5" cellspacing="0"   style="width:100%;">';
                sOut += '<thead><tr style="color:#fff8f8;font-size:12px;background-color: #6acc6a;"><th>Product Name</th><th>Qty</th><th>Unit</th><th>Unit Cost</th><th>Total</th><th>Width</th><th>Height</th><th>Description</th></tr></thead><tbody>';

                itemData.items.forEach(item => {
                    sOut += `<tr >
                    <td>${item.product_name || ''}</td>
                    <td>${item.quantity || 0}</td>
                    <td>${item.unit || ''}</td>
                    <td>${item.unit_cost || 0}</td>
                    <td>${item.total_cost || 0}</td>
                    <td>${item.width || 0}</td>
                    <td>${item.height || 0}</td>
                    <td>${item.description || ''}</td>
                    </tr>`;
                });

                sOut += '</tbody></table>';
                // select create from select approved,reject,cancel input discount table add 
                if (approvestatus === 'pending' && approver === parseInt('{{ request.user.id }}')) {
                        sOut += `
                            <div class="action-btn mt-2">
                                <label><b>Action:</b></label>
                                <select class="form-control d-inline-block" id="action-${quotationId}" style="width: 150px;">
                                    <option value="">--Select--</option>
                                    <option value="approved">Approve</option>
                                    <option value="rejected">Reject</option>
                                    <option value="cancelled">Cancel</option>
                                </select>

                                <label class="ml-3"><b>Discount (%):</b></label>
                                <input type="number" class="form-control d-inline-block" id="discount-${quotationId}" min="0" max="100" style="width: 100px;" placeholder="0">

                                <button class="btn btn-primary ml-2" onclick="submitQuotationAction(${quotationId})">Submit</button>
                            </div>
                        `;
                    }
                 
                return sOut;
            }


            $(document).ready(function() {

                $('#dynamic-table').dataTable( {
                    "aaSorting": [[ 4, "desc" ]]
                } );
                const plusIcon = `<i class="fa fa-plus-square  text-success" style="font-size:22px;"></i>`;
                const minusIconClass = "fa-minus-square";
                const plusIconClass = "fa-plus-square";
                var nCloneTh = document.createElement( 'th' );
                var nCloneTd = document.createElement( 'td' );
                nCloneTd.innerHTML = plusIcon;
                nCloneTd.className = "center";

                $('#hidden-table-info thead tr').each( function () {
                    this.insertBefore( nCloneTh, this.childNodes[0] );
                } );

                $('#hidden-table-info tbody tr').each( function () {
                    this.insertBefore(  nCloneTd.cloneNode( true ), this.childNodes[0] );
                } );

                /*
                * Initialse DataTables, with no sorting on the 'details' column
                */
                var oTable = $('#hidden-table-info').dataTable( {
                    "aoColumnDefs": [
                        { "bSortable": false, "aTargets": [ 0 ] }
                    ],
                    "aaSorting": [[1, 'asc']]
                });

                /* Add event listener for opening and closing details
                * Note that the indicator for showing which row is open is not controlled by DataTables,
                * rather it is done here
                */
            $(document).on('click', '#hidden-table-info tbody td i', function () {
            const tr = $(this).closest('tr')[0];

            if (oTable.fnIsOpen(tr)) {
                oTable.fnClose(tr);
                $(this)
                .removeClass(minusIconClass + ' text-danger')
                .addClass(plusIconClass + ' text-success');
            } else {
                const sOut = fnFormatDetails(oTable, tr);
                oTable.fnOpen(tr, sOut, 'details');
                $(this)
                .removeClass(plusIconClass + ' text-success')
                .addClass(minusIconClass + ' text-danger');
            }
            });
    } );
      </script>
 <script>
$(document).ready(function () {
    let counter = 0;

    const unitMap = {
        '1': 'mm', '2': 'cm', '3': 'm', '4': 'in', '5': 'ft',
        '6': 'mm¬≤', '7': 'cm¬≤', '8': 'm¬≤', '9': 'in¬≤', '10': 'ft¬≤'
    };

    const PRODUCTS_DATA = {
        {% for product in products %}
        "{{ product.id }}": {
            name: "{{ product.name|escapejs }}",
            width: {{ product.width|default:"null" }},
            height: {{ product.height|default:"null" }},
            price: {{ product.price|default:0 }},
            unit: "{{ product.unit.symbol|default:'mm' }}"
        },
        {% endfor %}
    };

    function convertToMM(value, unitSymbol) {
        const conversionRates = {
            'mm': 1, 'cm': 10, 'm': 1000, 'in': 25.4, 'ft': 304.8,
            'mm¬≤': 1, 'cm¬≤': 100, 'm¬≤': 1000000, 'in¬≤': 645.16, 'ft¬≤': 92903.04
        };
        return value * (conversionRates[unitSymbol.toLowerCase()] || 1);
    }

    function calculateTotal(row) {
        const qty = parseFloat(row.find('.qty-input').val()) || 0;
        const selectedOption = row.find('.product-select option:selected');
        const productId = selectedOption.val();
        const product = PRODUCTS_DATA[productId];

        if (!product || !product.price) {
            row.find('.total-cost').val("Invalid");
            return;
        }

        const hasDimensions = product.width && product.height;

        if (hasDimensions) {
            const width = parseFloat(row.find('input[name^="width_"]').val()) || 0;
            const height = parseFloat(row.find('input[name^="height_"]').val()) || 0;

            const inputUnit = row.find('.unit-select').val() || '1';
            const selectedUnitName = unitMap[inputUnit] || 'mm';
            const productUnitName = product.unit || 'mm';

            const widthInMM = convertToMM(width, selectedUnitName);
            const heightInMM = convertToMM(height, selectedUnitName);
            const productWidthInMM = convertToMM(product.width, productUnitName);
            const productHeightInMM = convertToMM(product.height, productUnitName);

            const productArea = productWidthInMM * productHeightInMM || 1;
            const requestedArea = widthInMM * heightInMM;

            const scale = requestedArea / productArea;
            const total = qty * product.price * scale;

            row.find('.total-cost').val(total.toFixed(2));
        } else {
            const total = qty * product.price;
            row.find('.total-cost').val(total.toFixed(2));
        }
    }

    function updateProductDropdowns() {
        const selectedValues = $('.product-select').map(function () {
            return $(this).val();
        }).get();

        $('.product-select').each(function () {
            const currentSelect = $(this);
            const currentVal = currentSelect.val();

            currentSelect.find('option').each(function () {
                const val = $(this).val();
                if (val === "" || val === currentVal) {
                    $(this).prop('disabled', false);
                } else {
                    $(this).prop('disabled', selectedValues.includes(val));
                }
            });
        });
    }

    // Add new row
    $(document).on('click', '#add-request-btn', function (e) {
        e.preventDefault();
        counter++;

        // Remove existing add buttons to prevent duplicates
        $('.add-request-btn').remove();

        const html = `
        <div class="form-group request-row custom-row-data mb-0" data-index="${counter}">
            <select name="product_${counter}" class="form-control product-select">
                <option value="">Select Product</option>
                {% for product in products %}
                    <option value="{{ product.id }}" data-price="{{ product.price }}">{{ product.name }}</option>
                {% endfor %}
            </select>
            <input type="number" class="form-control qty-input" name="qty_${counter}" placeholder="Qty" />
            <input type="number" class="form-control" name="width_${counter}" placeholder="Width" />
            <input type="number" class="form-control" name="height_${counter}" placeholder="Height" />
            <select class="form-control unit-select" name="unit_${counter}">
                {% for unit in units %}
                    <option value="{{ unit.id }}">{{ unit.symbol }}</option>
                {% empty %}
                    <option disabled>No Unit available</option>
                {% endfor %}
            </select>
            <input type="text" class="form-control total-cost" name="unit_cost_${counter}" readonly placeholder="Total" />
            <a class="btn-sm remove-row"><i class="text-danger fa fa-minus-square"></i></a>
        </div>
        `;

        $('#add-requests').append(html);

        // Always re-append the "+" to the first row
        const firstRow = $('.request-row').first();
        if (firstRow.length > 0) {
            firstRow.append(`
                <a href="#" class="btn-sm add-request-btn" id="add-request-btn">
                    <i class="text-success fa fa-plus-square"></i>
                </a>
            `);
        }
    });

    // Remove row
    $(document).on('click', '.remove-row', function () {
        const row = $(this).closest('.request-row');
        const hadAddButton = row.find('#add-request-btn').length > 0;
        row.remove();

        if (hadAddButton) {
            const firstRow = $('.request-row').first();
            if (firstRow.length > 0) {
                // Re-append the "+" button to the first row
                firstRow.append(`
                    <a href="#" class="btn-sm add-request-btn" id="add-request-btn">
                        <i class="text-success fa fa-plus-square"></i>
                    </a>
                `);
            }
        }
    });

    // Prevent duplicate product selections
    $(document).on('change', '.product-select', function () {
        updateProductDropdowns();
        calculateTotal($(this).closest('.request-row'));
    });

    // On quantity/width/height/unit input change, recalculate
    $(document).on('input change', '.qty-input, .unit-select, input[name^="width_"], input[name^="height_"]', function () {
        calculateTotal($(this).closest('.request-row'));
    });
});
     
// Utility to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Check cookie name
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function Apitest(id) {
    const url = "{% url 'quotation_test' %}";  // Make sure this is your Django view URL

    fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken'),
        },
        body: JSON.stringify({ document_id: 17 })  
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "quotation.pdf";  // desired filename
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error("Error:", error);
        showMessage("Something went wrong!", "danger");
    });
}

    $('#submit-customer').click(function (e) {
        e.preventDefault();
        const data = {
            name: $('#name').val(),
            email: $('#inputEmail3').val(),
            phone_number: $('#inputPassword3[name="phone_number"]').val(),
            gst_number: $('#inputPassword3[name="gst_number"]').val()
        };

        $.ajax({
            url: "{% url 'register-customer' %}",  // üîÅ Replace with your actual URL
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                alert(response.message);
                $('#customer-form')[0].reset();
                $('#add-customer').removeClass('show').removeAttr('style').attr('aria-hidden', 'true');
                $('.modal-backdrop').remove(); 
                $('body').removeClass('modal-open');  
            },
            error: function (xhr) {
                const res = xhr.responseJSON;
                alert("Error: " + (res.message || 'Something went wrong.'));
                console.log(res.errors);
            }
        });
    });
function submitQuotationAction(id) {
    const action = document.querySelector(`#action-${id}`).value;
    const discount = document.querySelector(`#discount-${id}`).value;

    if (!action) {
        alert("Please select an action.");
        return;
    }

    if (discount && (discount < 0 || discount > 100)) {
        alert("Discount must be between 0 and 100.");
        return;
    }

    const url = "{% url 'quotaion_approval' 0 %}".replace(0, id);
 

    fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCookie('csrftoken'),
        },
        body: new URLSearchParams({
            discount: discount,
            status: action
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || "Something went wrong");
            });
        }
        return response.json();
    })
    .then(data => {
        alert(data.message || "Quotation updated successfully.");
        // Optionally reload table or refresh row
    })
    .catch(error => {
        alert("Error: " + error.message);
    });
}
</script>



{% endblock %}