
{% extends 'base/container.html' %}
{% load static %}
{% block title %} Invoice-Peport {% endblock %}

{% block style %}
<style>
    label {
    display: unset; 
    margin-bottom: .5rem;
}
.class-filter {
    display: flex;
    align-items: flex-end;
}
</style>


{% endblock %}
{% block body_content %} 


 <div class="wrapper">
   <div class="wrapper-title">
    <div class="wrapper-content">Invoice Report List</div>
    <div class="wrapper-actions">
        <button class="btn btn-secondary" style="display: inline-flex;gap:2px;" onclick="history.back()">  <i class="material-icons">arrow_circle_left</i>Back</button>
    </div>
   </div> 
 
    <div class="card ">
    <!--Qoutaion Report List Table Start-->
        <div class="adv-table">   
            <div class="class-filter row">
                <div class="col-2">
                  
                     <label cfor ="quotation">Quotation</lable>
                     <select class="form-control select2" name="quotation" id ="quotation" multiple="multiple" placeholder="select">
                         {% for quotation in quotations%}
                         <option value="{{quotation.id}}">{{quotation}}</option>
                        {% endfor%}
                     </select>
                  
                </div>
                <div class="col-2">
                    <label class="form-lable" for ="customers">Customers </lable>
                    <select class="form-control select2" name="customer" id="customer" multiple="multiple">
                         {% for customer in customers%}
                       <option value="{{customer.customer__id}}">{{customer.customer__name}}</option>
                         {% endfor%}
                     </select>
                </div>
                <div class="col-2">
                    <label class="form-lable" for ="approver">Approvers </lable>
                    <select class="form-control select2" name="approver" id="approver" multiple="multiple">
                         {% for approver in approvers%}
                       <option value="{{approver.approver__id}}">{{approver.approver__first_name}}</option>
                          {% endfor%}
                     </select>
                </div>
                <div class="col-2">
                    <label class="form-lable" for ="status">Status</lable>
                    <select class="form-control select2" name="status" id ="status">
                        <option value="">All</option>           
                       <option value="pending">Pending</option>
                       <option value="approved">Approved</option>
                       <option value="rejected">Rejected</option>                         
                     </select>
                </div>
                <div class="col-2">
                    <label class="form-lable" for ="approver">Request date</lable>
                    <input type="date" class="form-control" id="request_date" name="request_date">
                </div>
                <div class="col-2">
                     
                     <button class="btn btn-warning" type="button"  onclick="fetchQuotations()">Filter</button>
                     <button class="btn btn-success" type="button" id="download-xlsx">Excel</button>
                </div>
               
             
            </div>
            <div class="mt-2" id="quotationTable"></div>
            {% comment %} <table id="quotationTable" class="display table table-bordered ">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Invoice</th>
                        <th>Approver</th>
                        <th>Price</th>
                        
                        <th>Status</th>
                        <th>Discount</th>
                        <th>Request Date</th>
                        <th>Customer</th>
                      
                    </tr>
                </thead>
                <tbody></tbody>
            </table> {% endcomment %}

        </div>
   </div>
 </div>


{% endblock %}
{% block js %}
<script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
<link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>

<script>
    // Initialize Tabulator (empty for now)
    var table = new Tabulator("#quotationTable", {
        height: "500px",
        layout: "fitColumns",
        pagination:"local",
        paginationSize:6,
        paginationSizeSelector:[3, 6, 8, 10],
        movableColumns:true,
        paginationCounter:"rows",
        height: "500px",
        responsiveLayout:"collapse",
        placeholder: "No records found",

        columns: [
            {title:"S.No", formatter:"rownum", width:70, hozAlign:"center"}, // auto increment column
            {title:"Invoice", field:"invoice_number"},
            {title:"Approver", field:"approver.name"},   // nested object field
            {title:"Price", field:"price", hozAlign:"right", formatter:"money"},
            {title:"Status", field:"status"},
            {title:"Discount", field:"discount", formatter:function(cell){
                let val = cell.getValue();
                return val !== null ? val+"%" : "";
            }},
            {title:"Request Date", field:"request_date"},
            {title:"Customer", field:"customer.name"},
        ],
    });

    // XLSX Export
    document.getElementById("download-xlsx").addEventListener("click", function(){
        table.download("xlsx", "quotations.xlsx", {sheetName:"Quotations"});
    });

    // Fetch data from Django backend
    function fetchQuotations() {
        const formData = new FormData();
        // Multiple selects
        let quotationVals = Array.from(document.getElementById("quotation").selectedOptions).map(opt => opt.value);
        let customerVals = Array.from(document.getElementById("customer").selectedOptions).map(opt => opt.value);
        let approverVals = Array.from(document.getElementById("approver").selectedOptions).map(opt => opt.value);
        quotationVals.forEach(val => formData.append("quotation", val));
        customerVals.forEach(val => formData.append("customer", val));
        approverVals.forEach(val => formData.append("approver", val));

        // Single values
        let statusVal = document.getElementById("status").value;
        let requestDateVal = document.getElementById("request_date").value;
        if (statusVal) formData.append("status", statusVal);
        if (requestDateVal) formData.append("request_date", requestDateVal);

        fetch(window.location.href, {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": getCookie("csrftoken")
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.data && data.data.length > 0) {
                table.setData(data.data);   // load data into Tabulator
            } else {
                table.clearData();          // clear if no records
            }
        })
        .catch(err => {
            console.error("Error:", err);
        });
    }

    // Run once on page load
    fetchQuotations();

    // CSRF helper for Django POST
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

{% endblock %}